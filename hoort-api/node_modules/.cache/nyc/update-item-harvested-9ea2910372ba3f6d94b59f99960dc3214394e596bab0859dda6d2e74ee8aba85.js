function cov_1q1iqbqx0z(){var path="/Users/So/bootcamp/collab/skylab-bootcamp-202001/staff/sofia-costa/hoort/hoort-api/logic/update-item-harvested.js";var hash="692a9e902d1fd20a81e60fa12d91d2643975742d";var global=new Function("return this")();var gcv="__coverage__";var coverageData={path:"/Users/So/bootcamp/collab/skylab-bootcamp-202001/staff/sofia-costa/hoort/hoort-api/logic/update-item-harvested.js",statementMap:{"0":{start:{line:1,column:21},end:{line:1,column:43}},"1":{start:{line:2,column:41},end:{line:2,column:62}},"2":{start:{line:3,column:42},end:{line:3,column:71}},"3":{start:{line:4,column:38},end:{line:4,column:57}},"4":{start:{line:5,column:15},end:{line:5,column:34}},"5":{start:{line:7,column:0},end:{line:150,column:1}},"6":{start:{line:8,column:4},end:{line:8,column:37}},"7":{start:{line:9,column:4},end:{line:9,column:37}},"8":{start:{line:10,column:4},end:{line:10,column:37}},"9":{start:{line:12,column:15},end:{line:12,column:42}},"10":{start:{line:14,column:21},end:{line:14,column:86}},"11":{start:{line:14,column:51},end:{line:14,column:85}},"12":{start:{line:16,column:4},end:{line:16,column:70}},"13":{start:{line:16,column:21},end:{line:16,column:70}},"14":{start:{line:18,column:4},end:{line:18,column:76}},"15":{start:{line:18,column:34},end:{line:18,column:76}},"16":{start:{line:20,column:4},end:{line:20,column:30}},"17":{start:{line:22,column:13},end:{line:22,column:26}},"18":{start:{line:23,column:15},end:{line:23,column:30}},"19":{start:{line:25,column:4},end:{line:25,column:38}},"20":{start:{line:26,column:4},end:{line:26,column:29}},"21":{start:{line:28,column:4},end:{line:28,column:21}},"22":{start:{line:30,column:15},end:{line:30,column:42}},"23":{start:{line:32,column:25},end:{line:32,column:55}},"24":{start:{line:34,column:4},end:{line:34,column:43}},"25":{start:{line:35,column:4},end:{line:35,column:43}},"26":{start:{line:37,column:4},end:{line:37,column:54}},"27":{start:{line:39,column:4},end:{line:39,column:62}},"28":{start:{line:40,column:4},end:{line:40,column:62}},"29":{start:{line:42,column:4},end:{line:45,column:53}},"30":{start:{line:43,column:8},end:{line:43,column:64}},"31":{start:{line:45,column:9},end:{line:45,column:53}},"32":{start:{line:47,column:4},end:{line:47,column:21}},"33":{start:{line:49,column:4},end:{line:49,column:10}}},fnMap:{"0":{name:"(anonymous_0)",decl:{start:{line:7,column:17},end:{line:7,column:18}},loc:{start:{line:7,column:51},end:{line:150,column:1}},line:7},"1":{name:"(anonymous_1)",decl:{start:{line:14,column:42},end:{line:14,column:43}},loc:{start:{line:14,column:51},end:{line:14,column:85}},line:14}},branchMap:{"0":{loc:{start:{line:16,column:4},end:{line:16,column:70}},type:"if",locations:[{start:{line:16,column:4},end:{line:16,column:70}},{start:{line:16,column:4},end:{line:16,column:70}}],line:16},"1":{loc:{start:{line:18,column:4},end:{line:18,column:76}},type:"if",locations:[{start:{line:18,column:4},end:{line:18,column:76}},{start:{line:18,column:4},end:{line:18,column:76}}],line:18},"2":{loc:{start:{line:42,column:4},end:{line:45,column:53}},type:"if",locations:[{start:{line:42,column:4},end:{line:45,column:53}},{start:{line:42,column:4},end:{line:45,column:53}}],line:42}},s:{"0":0,"1":0,"2":0,"3":0,"4":0,"5":0,"6":0,"7":0,"8":0,"9":0,"10":0,"11":0,"12":0,"13":0,"14":0,"15":0,"16":0,"17":0,"18":0,"19":0,"20":0,"21":0,"22":0,"23":0,"24":0,"25":0,"26":0,"27":0,"28":0,"29":0,"30":0,"31":0,"32":0,"33":0},f:{"0":0,"1":0},b:{"0":[0,0],"1":[0,0],"2":[0,0]},_coverageSchema:"1a1c01bbd47fc00a2c39e90264f33305004495a9",hash:"692a9e902d1fd20a81e60fa12d91d2643975742d"};var coverage=global[gcv]||(global[gcv]={});if(!coverage[path]||coverage[path].hash!==hash){coverage[path]=coverageData;}var actualCoverage=coverage[path];cov_1q1iqbqx0z=function(){return actualCoverage;};return actualCoverage;}cov_1q1iqbqx0z();const{validate}=(cov_1q1iqbqx0z().s[0]++,require('hoort-utils'));const{models:{Land,Item,User}}=(cov_1q1iqbqx0z().s[1]++,require('hoort-data'));const{NotAllowedError,ContentError}=(cov_1q1iqbqx0z().s[2]++,require('../../hoort-errors'));const{SchemaTypes:{ObjectId}}=(cov_1q1iqbqx0z().s[3]++,require('mongoose'));const bcrypt=(cov_1q1iqbqx0z().s[4]++,require('bcryptjs'));cov_1q1iqbqx0z().s[5]++;module.exports=async(userId,landId,itemId)=>{cov_1q1iqbqx0z().f[0]++;cov_1q1iqbqx0z().s[6]++;validate.string(userId,'userId');cov_1q1iqbqx0z().s[7]++;validate.string(landId,'landId');cov_1q1iqbqx0z().s[8]++;validate.string(itemId,'itemId');let land=(cov_1q1iqbqx0z().s[9]++,await Land.findById(landId));let plantation=(cov_1q1iqbqx0z().s[10]++,land.plantation.find(plant=>{cov_1q1iqbqx0z().f[1]++;cov_1q1iqbqx0z().s[11]++;return plant.veggie.toString()===itemId;}));cov_1q1iqbqx0z().s[12]++;if(!plantation){cov_1q1iqbqx0z().b[0][0]++;cov_1q1iqbqx0z().s[13]++;throw new Error('this item is not added to land');}else{cov_1q1iqbqx0z().b[0][1]++;}cov_1q1iqbqx0z().s[14]++;if(plantation.from===null){cov_1q1iqbqx0z().b[1][0]++;cov_1q1iqbqx0z().s[15]++;throw new Error('item is not planted yet');}else{cov_1q1iqbqx0z().b[1][1]++;}cov_1q1iqbqx0z().s[16]++;plantation.to=new Date();let to=(cov_1q1iqbqx0z().s[17]++,plantation.to);let from=(cov_1q1iqbqx0z().s[18]++,plantation.from);cov_1q1iqbqx0z().s[19]++;plantation=plantation.toObject();cov_1q1iqbqx0z().s[20]++;delete plantation.estTime;cov_1q1iqbqx0z().s[21]++;await land.save();let item=(cov_1q1iqbqx0z().s[22]++,await Item.findById(itemId));let growthDuration=(cov_1q1iqbqx0z().s[23]++,item.growthDuration.split('-'));cov_1q1iqbqx0z().s[24]++;minDuration=Number(growthDuration[0]);cov_1q1iqbqx0z().s[25]++;maxDuration=Number(growthDuration[1]);cov_1q1iqbqx0z().s[26]++;userDuration=(from.getDate()+to.getDate())/2;cov_1q1iqbqx0z().s[27]++;minDuration=Math.floor((minDuration+userDuration)/2);cov_1q1iqbqx0z().s[28]++;maxDuration=Math.floor((maxDuration+userDuration)/2);cov_1q1iqbqx0z().s[29]++;if(item.growthDurationAll){cov_1q1iqbqx0z().b[2][0]++;cov_1q1iqbqx0z().s[30]++;item.growthDurationAll=`${minDuration}-${maxDuration}`;}else{cov_1q1iqbqx0z().b[2][1]++;cov_1q1iqbqx0z().s[31]++;item.growthDurationAll=item.growthDuration;}cov_1q1iqbqx0z().s[32]++;await item.save();cov_1q1iqbqx0z().s[33]++;return;// return Land.findById(landId)//.populate('plantation', 'from')
//     .then(_land => {
//         plantation = _land.plantation.find(plant => plant.veggie.toString() === itemId)
//         from = plantation.from
//         plantation.from = plantation.from
//         plantation.to = new Date()
//         to = plantation.to
//         return _land.save()
//     })
//     .then(() => Item.findById(itemId))
//     .then(item => {
//         growthDuration = item.growthDuration.split('-')
//         minDuration = Number(growthDuration[0])
//         maxDuration = Number(growthDuration[1])
//         userDuration = (from.getDate() + to.getDate())/2
//         growthDuration = item.growthDuration
//         minDuration = (minDuration + userDuration)/2
//         maxDuration = (maxDuration + userDuration)/2
//         if (item.growthDurationAll)
//             item.growthDurationAll = `${minDuration}-${maxDuration}`
//         else item.growthDurationAll = growthDuration
//         console.log(item.growthDurationAll)
//         item.save()
//     })
// let planted, veggie, growthDuration, minDuration, maxDuration, userDuration
// return Item.findById(itemId)
//     .then(item => { 
//         if(!item) throw new ContentError('item does not exist')
//         growthDuration = item.growthDuration
//         let _growthDuration = growthDuration.split('-')
//         minDuration = Number(_growthDuration[0])
//         maxDuration = Number(_growthDuration[1])
//     })
//     .then(() => Land.findById(landId))
//     .then(land => {             
//         veggie = land.veggies.find(veggie => veggie._id.toString() === itemId)
//         if(!veggie) throw new Error('this veggie is not on this land')
//         userDuration = land.veggies[land.veggies.indexOf(veggie)].userTime
//         let today = new Date()
//         let newdateMin = new Date()
//         let newdateMax = new Date()
//         newdateMin.setDate(today.getDate() + minDuration)
//         newdateMax.setDate(today.getDate() + maxDuration)
//         today = today.getDate() + "/" + (today.getMonth() + 1) + "/" + today.getFullYear()
//         newdateMin = newdateMin.getDate() + "/" + (newdateMin.getMonth() + 1) + "/" + newdateMin.getFullYear()
//         newdateMax = newdateMax.getDate() + "/" + (newdateMax.getMonth() + 1) + "/" + newdateMax.getFullYear()
//         land.veggies[land.veggies.indexOf(veggie)].estTime = 0
//         land.veggies[land.veggies.indexOf(veggie)].userTime = 0
//         land.veggies[land.veggies.indexOf(veggie)].state = "harvested"
//         planted = land.veggies[land.veggies.indexOf(veggie)].planted
//         return land.save()
//     })
//     .then(() => Item.findById(itemId))
//     .then(item => {
//         let today = new Date()
//         let differenceInTime = today.getTime() - planted.getTime()
//         let differenceInDays = Math.floor(differenceInTime / (1000 * 3600 * 24))
//         item.growthDurationUser = differenceInDays
//         if (item.growthDurationAll)
//             item.growthDurationAll = (item.growthDurationAll + userDuration)/2
//         else item.growthDurationAll = userDuration
//         item.save()
//     })
//     .then(() => {})
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInVwZGF0ZS1pdGVtLWhhcnZlc3RlZC5qcyJdLCJuYW1lcyI6WyJ2YWxpZGF0ZSIsInJlcXVpcmUiLCJtb2RlbHMiLCJMYW5kIiwiSXRlbSIsIlVzZXIiLCJOb3RBbGxvd2VkRXJyb3IiLCJDb250ZW50RXJyb3IiLCJTY2hlbWFUeXBlcyIsIk9iamVjdElkIiwiYmNyeXB0IiwibW9kdWxlIiwiZXhwb3J0cyIsInVzZXJJZCIsImxhbmRJZCIsIml0ZW1JZCIsInN0cmluZyIsImxhbmQiLCJmaW5kQnlJZCIsInBsYW50YXRpb24iLCJmaW5kIiwicGxhbnQiLCJ2ZWdnaWUiLCJ0b1N0cmluZyIsIkVycm9yIiwiZnJvbSIsInRvIiwiRGF0ZSIsInRvT2JqZWN0IiwiZXN0VGltZSIsInNhdmUiLCJpdGVtIiwiZ3Jvd3RoRHVyYXRpb24iLCJzcGxpdCIsIm1pbkR1cmF0aW9uIiwiTnVtYmVyIiwibWF4RHVyYXRpb24iLCJ1c2VyRHVyYXRpb24iLCJnZXREYXRlIiwiTWF0aCIsImZsb29yIiwiZ3Jvd3RoRHVyYXRpb25BbGwiXSwibWFwcGluZ3MiOiIrdkhBQUEsS0FBTSxDQUFFQSxRQUFGLDJCQUFlQyxPQUFPLENBQUMsYUFBRCxDQUF0QixDQUFOLENBQ0EsS0FBTSxDQUFFQyxNQUFNLENBQUUsQ0FBRUMsSUFBRixDQUFRQyxJQUFSLENBQWNDLElBQWQsQ0FBViwyQkFBbUNKLE9BQU8sQ0FBQyxZQUFELENBQTFDLENBQU4sQ0FDQSxLQUFNLENBQUVLLGVBQUYsQ0FBbUJDLFlBQW5CLDJCQUFvQ04sT0FBTyxDQUFDLG9CQUFELENBQTNDLENBQU4sQ0FDQSxLQUFNLENBQUVPLFdBQVcsQ0FBRSxDQUFFQyxRQUFGLENBQWYsMkJBQWdDUixPQUFPLENBQUMsVUFBRCxDQUF2QyxDQUFOLENBQ0EsS0FBTVMsQ0FBQUEsTUFBTSwwQkFBR1QsT0FBTyxDQUFDLFVBQUQsQ0FBVixDQUFaLEMsd0JBRUFVLE1BQU0sQ0FBQ0MsT0FBUCxDQUFpQixNQUFPQyxNQUFQLENBQWVDLE1B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QTtBQUNBO0FBR0E7QUFFQTtBQUNBO0FBQ0E7QUFFQTtBQUVBO0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBRUE7QUFFQTtBQUVBO0FBQ0E7QUFDQTtBQUVBO0FBQ0E7QUFFQTtBQUNBO0FBQ0E7QUFFQTtBQUNBO0FBQ0E7QUFDQTtBQUVBO0FBRUE7QUFDQTtBQUNBO0FBRUE7QUFDQTtBQUNBO0FBRUE7QUFFQTtBQUNBO0FBRUE7QUFFQTtBQUNBO0FBQ0E7QUFDSCxDQS9JRCIsInNvdXJjZXNDb250ZW50IjpbImNvbnN0IHsgdmFsaWRhdGUgfSA9IHJlcXVpcmUoJ2hvb3J0LXV0aWxzJylcbmNvbnN0IHsgbW9kZWxzOiB7IExhbmQsIEl0ZW0sIFVzZXIgfSB9ID0gcmVxdWlyZSgnaG9vcnQtZGF0YScpXG5jb25zdCB7IE5vdEFsbG93ZWRFcnJvciwgQ29udGVudEVycm9yIH0gPSByZXF1aXJlKCcuLi8uLi9ob29ydC1lcnJvcnMnKVxuY29uc3QgeyBTY2hlbWFUeXBlczogeyBPYmplY3RJZCB9IH0gPSByZXF1aXJlKCdtb25nb29zZScpXG5jb25zdCBiY3J5cHQgPSByZXF1aXJlKCdiY3J5cHRqcycpXG5cbm1vZHVsZS5leHBvcnRzID0gYXN5bmMgKHVzZXJJZCwgbGFuZElkLCBpdGVtSWQpID0+IHtcbiAgICB2YWxpZGF0ZS5zdHJpbmcodXNlcklkLCAndXNlcklkJylcbiAgICB2YWxpZGF0ZS5zdHJpbmcobGFuZElkLCAnbGFuZElkJylcbiAgICB2YWxpZGF0ZS5zdHJpbmcoaXRlbUlkLCAnaXRlbUlkJylcblxuICAgIGxldCBsYW5kID0gYXdhaXQgTGFuZC5maW5kQnlJZChsYW5kSWQpXG5cbiAgICBsZXQgcGxhbnRhdGlvbiA9IGxhbmQucGxhbnRhdGlvbi5maW5kKHBsYW50ID0+IHBsYW50LnZlZ2dpZS50b1N0cmluZygpID09PSBpdGVtSWQpXG5cbiAgICBpZiAoIXBsYW50YXRpb24pIHRocm93IG5ldyBFcnJvcigndGhpcyBpdGVtIGlzIG5vdCBhZGRlZCB0byBsYW5kJylcblxuICAgIGlmIChwbGFudGF0aW9uLmZyb20gPT09IG51bGwpIHRocm93IG5ldyBFcnJvcignaXRlbSBpcyBub3QgcGxhbnRlZCB5ZXQnKVxuXG4gICAgcGxhbnRhdGlvbi50byA9IG5ldyBEYXRlKClcblxuICAgIGxldCB0byA9IHBsYW50YXRpb24udG9cbiAgICBsZXQgZnJvbSA9IHBsYW50YXRpb24uZnJvbVxuXG4gICAgcGxhbnRhdGlvbiA9IHBsYW50YXRpb24udG9PYmplY3QoKVxuICAgIGRlbGV0ZSBwbGFudGF0aW9uLmVzdFRpbWVcblxuICAgIGF3YWl0IGxhbmQuc2F2ZSgpXG5cbiAgICBsZXQgaXRlbSA9IGF3YWl0IEl0ZW0uZmluZEJ5SWQoaXRlbUlkKVxuXG4gICAgbGV0IGdyb3d0aER1cmF0aW9uID0gaXRlbS5ncm93dGhEdXJhdGlvbi5zcGxpdCgnLScpXG5cbiAgICBtaW5EdXJhdGlvbiA9IE51bWJlcihncm93dGhEdXJhdGlvblswXSlcbiAgICBtYXhEdXJhdGlvbiA9IE51bWJlcihncm93dGhEdXJhdGlvblsxXSlcblxuICAgIHVzZXJEdXJhdGlvbiA9IChmcm9tLmdldERhdGUoKSArIHRvLmdldERhdGUoKSkgLyAyXG5cbiAgICBtaW5EdXJhdGlvbiA9IE1hdGguZmxvb3IoKG1pbkR1cmF0aW9uICsgdXNlckR1cmF0aW9uKSAvIDIpXG4gICAgbWF4RHVyYXRpb24gPSBNYXRoLmZsb29yKChtYXhEdXJhdGlvbiArIHVzZXJEdXJhdGlvbikgLyAyKVxuXG4gICAgaWYgKGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwpXG4gICAgICAgIGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwgPSBgJHttaW5EdXJhdGlvbn0tJHttYXhEdXJhdGlvbn1gXG5cbiAgICBlbHNlIGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwgPSBpdGVtLmdyb3d0aER1cmF0aW9uXG5cbiAgICBhd2FpdCBpdGVtLnNhdmUoKVxuXG4gICAgcmV0dXJuXG5cbiAgICAvLyByZXR1cm4gTGFuZC5maW5kQnlJZChsYW5kSWQpLy8ucG9wdWxhdGUoJ3BsYW50YXRpb24nLCAnZnJvbScpXG4gICAgLy8gICAgIC50aGVuKF9sYW5kID0+IHtcblxuICAgIC8vICAgICAgICAgcGxhbnRhdGlvbiA9IF9sYW5kLnBsYW50YXRpb24uZmluZChwbGFudCA9PiBwbGFudC52ZWdnaWUudG9TdHJpbmcoKSA9PT0gaXRlbUlkKVxuXG4gICAgLy8gICAgICAgICBmcm9tID0gcGxhbnRhdGlvbi5mcm9tXG5cbiAgICAvLyAgICAgICAgIHBsYW50YXRpb24uZnJvbSA9IHBsYW50YXRpb24uZnJvbVxuXG4gICAgLy8gICAgICAgICBwbGFudGF0aW9uLnRvID0gbmV3IERhdGUoKVxuXG4gICAgLy8gICAgICAgICB0byA9IHBsYW50YXRpb24udG9cblxuICAgIC8vICAgICAgICAgcmV0dXJuIF9sYW5kLnNhdmUoKVxuICAgIC8vICAgICB9KVxuICAgIC8vICAgICAudGhlbigoKSA9PiBJdGVtLmZpbmRCeUlkKGl0ZW1JZCkpXG4gICAgLy8gICAgIC50aGVuKGl0ZW0gPT4ge1xuXG4gICAgLy8gICAgICAgICBncm93dGhEdXJhdGlvbiA9IGl0ZW0uZ3Jvd3RoRHVyYXRpb24uc3BsaXQoJy0nKVxuXG4gICAgLy8gICAgICAgICBtaW5EdXJhdGlvbiA9IE51bWJlcihncm93dGhEdXJhdGlvblswXSlcbiAgICAvLyAgICAgICAgIG1heER1cmF0aW9uID0gTnVtYmVyKGdyb3d0aER1cmF0aW9uWzFdKVxuXG4gICAgLy8gICAgICAgICB1c2VyRHVyYXRpb24gPSAoZnJvbS5nZXREYXRlKCkgKyB0by5nZXREYXRlKCkpLzJcblxuICAgIC8vICAgICAgICAgZ3Jvd3RoRHVyYXRpb24gPSBpdGVtLmdyb3d0aER1cmF0aW9uXG5cbiAgICAvLyAgICAgICAgIG1pbkR1cmF0aW9uID0gKG1pbkR1cmF0aW9uICsgdXNlckR1cmF0aW9uKS8yXG4gICAgLy8gICAgICAgICBtYXhEdXJhdGlvbiA9IChtYXhEdXJhdGlvbiArIHVzZXJEdXJhdGlvbikvMlxuXG4gICAgLy8gICAgICAgICBpZiAoaXRlbS5ncm93dGhEdXJhdGlvbkFsbClcbiAgICAvLyAgICAgICAgICAgICBpdGVtLmdyb3d0aER1cmF0aW9uQWxsID0gYCR7bWluRHVyYXRpb259LSR7bWF4RHVyYXRpb259YFxuXG4gICAgLy8gICAgICAgICBlbHNlIGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwgPSBncm93dGhEdXJhdGlvblxuXG4gICAgLy8gICAgICAgICBjb25zb2xlLmxvZyhpdGVtLmdyb3d0aER1cmF0aW9uQWxsKVxuXG4gICAgLy8gICAgICAgICBpdGVtLnNhdmUoKVxuICAgIC8vICAgICB9KVxuXG5cbiAgICAvLyBsZXQgcGxhbnRlZCwgdmVnZ2llLCBncm93dGhEdXJhdGlvbiwgbWluRHVyYXRpb24sIG1heER1cmF0aW9uLCB1c2VyRHVyYXRpb25cblxuICAgIC8vIHJldHVybiBJdGVtLmZpbmRCeUlkKGl0ZW1JZClcbiAgICAvLyAgICAgLnRoZW4oaXRlbSA9PiB7IFxuICAgIC8vICAgICAgICAgaWYoIWl0ZW0pIHRocm93IG5ldyBDb250ZW50RXJyb3IoJ2l0ZW0gZG9lcyBub3QgZXhpc3QnKVxuXG4gICAgLy8gICAgICAgICBncm93dGhEdXJhdGlvbiA9IGl0ZW0uZ3Jvd3RoRHVyYXRpb25cblxuICAgIC8vICAgICAgICAgbGV0IF9ncm93dGhEdXJhdGlvbiA9IGdyb3d0aER1cmF0aW9uLnNwbGl0KCctJylcblxuICAgIC8vICAgICAgICAgbWluRHVyYXRpb24gPSBOdW1iZXIoX2dyb3d0aER1cmF0aW9uWzBdKVxuICAgIC8vICAgICAgICAgbWF4RHVyYXRpb24gPSBOdW1iZXIoX2dyb3d0aER1cmF0aW9uWzFdKVxuICAgIC8vICAgICB9KVxuICAgIC8vICAgICAudGhlbigoKSA9PiBMYW5kLmZpbmRCeUlkKGxhbmRJZCkpXG4gICAgLy8gICAgIC50aGVuKGxhbmQgPT4geyAgICAgICAgICAgICBcblxuICAgIC8vICAgICAgICAgdmVnZ2llID0gbGFuZC52ZWdnaWVzLmZpbmQodmVnZ2llID0+IHZlZ2dpZS5faWQudG9TdHJpbmcoKSA9PT0gaXRlbUlkKVxuXG4gICAgLy8gICAgICAgICBpZighdmVnZ2llKSB0aHJvdyBuZXcgRXJyb3IoJ3RoaXMgdmVnZ2llIGlzIG5vdCBvbiB0aGlzIGxhbmQnKVxuXG4gICAgLy8gICAgICAgICB1c2VyRHVyYXRpb24gPSBsYW5kLnZlZ2dpZXNbbGFuZC52ZWdnaWVzLmluZGV4T2YodmVnZ2llKV0udXNlclRpbWVcblxuICAgIC8vICAgICAgICAgbGV0IHRvZGF5ID0gbmV3IERhdGUoKVxuICAgIC8vICAgICAgICAgbGV0IG5ld2RhdGVNaW4gPSBuZXcgRGF0ZSgpXG4gICAgLy8gICAgICAgICBsZXQgbmV3ZGF0ZU1heCA9IG5ldyBEYXRlKClcblxuICAgIC8vICAgICAgICAgbmV3ZGF0ZU1pbi5zZXREYXRlKHRvZGF5LmdldERhdGUoKSArIG1pbkR1cmF0aW9uKVxuICAgIC8vICAgICAgICAgbmV3ZGF0ZU1heC5zZXREYXRlKHRvZGF5LmdldERhdGUoKSArIG1heER1cmF0aW9uKVxuXG4gICAgLy8gICAgICAgICB0b2RheSA9IHRvZGF5LmdldERhdGUoKSArIFwiL1wiICsgKHRvZGF5LmdldE1vbnRoKCkgKyAxKSArIFwiL1wiICsgdG9kYXkuZ2V0RnVsbFllYXIoKVxuICAgIC8vICAgICAgICAgbmV3ZGF0ZU1pbiA9IG5ld2RhdGVNaW4uZ2V0RGF0ZSgpICsgXCIvXCIgKyAobmV3ZGF0ZU1pbi5nZXRNb250aCgpICsgMSkgKyBcIi9cIiArIG5ld2RhdGVNaW4uZ2V0RnVsbFllYXIoKVxuICAgIC8vICAgICAgICAgbmV3ZGF0ZU1heCA9IG5ld2RhdGVNYXguZ2V0RGF0ZSgpICsgXCIvXCIgKyAobmV3ZGF0ZU1heC5nZXRNb250aCgpICsgMSkgKyBcIi9cIiArIG5ld2RhdGVNYXguZ2V0RnVsbFllYXIoKVxuXG4gICAgLy8gICAgICAgICBsYW5kLnZlZ2dpZXNbbGFuZC52ZWdnaWVzLmluZGV4T2YodmVnZ2llKV0uZXN0VGltZSA9IDBcbiAgICAvLyAgICAgICAgIGxhbmQudmVnZ2llc1tsYW5kLnZlZ2dpZXMuaW5kZXhPZih2ZWdnaWUpXS51c2VyVGltZSA9IDBcbiAgICAvLyAgICAgICAgIGxhbmQudmVnZ2llc1tsYW5kLnZlZ2dpZXMuaW5kZXhPZih2ZWdnaWUpXS5zdGF0ZSA9IFwiaGFydmVzdGVkXCJcbiAgICAvLyAgICAgICAgIHBsYW50ZWQgPSBsYW5kLnZlZ2dpZXNbbGFuZC52ZWdnaWVzLmluZGV4T2YodmVnZ2llKV0ucGxhbnRlZFxuXG4gICAgLy8gICAgICAgICByZXR1cm4gbGFuZC5zYXZlKClcblxuICAgIC8vICAgICB9KVxuICAgIC8vICAgICAudGhlbigoKSA9PiBJdGVtLmZpbmRCeUlkKGl0ZW1JZCkpXG4gICAgLy8gICAgIC50aGVuKGl0ZW0gPT4ge1xuXG4gICAgLy8gICAgICAgICBsZXQgdG9kYXkgPSBuZXcgRGF0ZSgpXG4gICAgLy8gICAgICAgICBsZXQgZGlmZmVyZW5jZUluVGltZSA9IHRvZGF5LmdldFRpbWUoKSAtIHBsYW50ZWQuZ2V0VGltZSgpXG4gICAgLy8gICAgICAgICBsZXQgZGlmZmVyZW5jZUluRGF5cyA9IE1hdGguZmxvb3IoZGlmZmVyZW5jZUluVGltZSAvICgxMDAwICogMzYwMCAqIDI0KSlcblxuICAgIC8vICAgICAgICAgaXRlbS5ncm93dGhEdXJhdGlvblVzZXIgPSBkaWZmZXJlbmNlSW5EYXlzXG5cbiAgICAvLyAgICAgICAgIGlmIChpdGVtLmdyb3d0aER1cmF0aW9uQWxsKVxuICAgIC8vICAgICAgICAgICAgIGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwgPSAoaXRlbS5ncm93dGhEdXJhdGlvbkFsbCArIHVzZXJEdXJhdGlvbikvMlxuXG4gICAgLy8gICAgICAgICBlbHNlIGl0ZW0uZ3Jvd3RoRHVyYXRpb25BbGwgPSB1c2VyRHVyYXRpb25cblxuICAgIC8vICAgICAgICAgaXRlbS5zYXZlKClcbiAgICAvLyAgICAgfSlcbiAgICAvLyAgICAgLnRoZW4oKCkgPT4ge30pXG59XG4iXX0=